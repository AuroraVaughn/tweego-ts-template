"use strict";!function(){if("undefined"==typeof version||void 0===version.title||"SugarCube"!==version.title||void 0===version.major||version.major<2||void 0===version.minor||version.minor<5)throw new Error("<<numberpool>> macro set requires SugarCube 2.5.0 or greater, aborting load");Macro.add("numberbox",{handler:function(){function e(e,t){var r=Math.trunc(Wikifier.getValue(u)),i=Math.trunc(e.value),a=null;if(Number.isNaN(i)||!Number.isFinite(i))return e.value=r,!1;if(null!=t&&(i+=t),i<o?i=o:l<i&&(i=l),null!==m){var n=m.get(),s=(i-r)*h;s<0?a=n-s:0<s&&h<=n?(n<s&&(i=r+Math.trunc(n/h),s=n-n%h),a=n-s):i=r}return Wikifier.setValue(u,i),e.value=i,null!==a&&m.set(a),!0}var t=this;if(this.args.length<4){var r=[];return this.args.length<1&&r.push("variable name"),this.args.length<2&&r.push("default value"),this.args.length<3&&r.push("min value"),this.args.length<4&&r.push("max value"),this.error("no "+r.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var u=this.args[0].trim();if("$"!==u[0]&&"_"!==u[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Util.slugify(u),a=Number(this.args[1]),o=Number(this.args[2]),l=Number(this.args[3]),h=1,n=!1;if(5<this.args.length?(h=Number(this.args[4]),n="autofocus"===this.args[5]):4<this.args.length&&("autofocus"===this.args[4]?n=!0:h=Number(this.args[4])),Number.isNaN(a)||!Number.isFinite(a)||Math.trunc(a)!==a)return this.error("default value ("+this.args[1]+") is not a whole number");if(Number.isNaN(o)||!Number.isFinite(o)||Math.trunc(o)!==o)return this.error("min value ("+this.args[2]+") is not a whole number");if(Number.isNaN(l)||!Number.isFinite(l)||Math.trunc(l)!==l)return this.error("max value ("+this.args[3]+") is not a whole number");if(Number.isNaN(h)||!Number.isFinite(h)||Math.trunc(h)!==h||h<=0)return this.error("pool cost ("+this.args[4]+") is not a whole number greater than zero");if(a<o)return this.error("default value ("+this.args[1]+") is less than min value ("+this.args[2]+")");if(l<a)return this.error("default value ("+this.args[1]+") is greater than max value ("+this.args[3]+")");var s,m=null!==(s=t.contextSelect(function(e){return"numberpool"===e.name}))&&s.hasOwnProperty("pool")?s.pool:null;Config.debug&&this.debugView.modes({block:!0});var g=jQuery(document.createElement("div")),f=jQuery(document.createElement("input"));g.attr("id",this.name+"-body-"+i).addClass("macro-"+this.name).appendTo(this.output),jQuery(document.createElement("button")).attr({id:this.name+"-minus-"+i,tabindex:0}).text("").on("click",function(){return e(f[0],-1)}).appendTo(g),f.attr({id:this.name+"-input-"+i,name:this.name+"-input-"+i,type:"text",pattern:"\\d+",tabindex:0}).on("change",function(){e(this)}).on("keypress",function(e){13===e.which&&(e.preventDefault(),f.trigger("change"))}).appendTo(g),jQuery(document.createElement("button")).attr({id:this.name+"-plus-"+i,tabindex:0}).text("").on("click",function(){return e(f[0],1)}).appendTo(g),f.val(a),e(f[0]),n&&(f.attr("autofocus","autofocus"),postdisplay["#autofocus:"+f.attr("id")]=function(e){delete postdisplay[e],setTimeout(function(){return f.focus()},Engine.minDomActionDelay)})}}),Macro.add("numberpool",{tags:["onchange"],handler:function(){if(0===this.args.length)return this.error("no variable name specified");if(2<this.payload.length)return this.error("multiple <<onchange>> sections specified");if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var e=Wikifier.getValue(t);if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e))return this.error("pool value is not a number");var r,i=Util.slugify(t);TempState.hasOwnProperty(this.name)||(TempState[this.name]={}),TempState[this.name].hasOwnProperty(i)||(TempState[this.name][i]=0),Object.defineProperty(this,"pool",{value:Object.defineProperties({},{get:{value:function(){return Wikifier.getValue(t)}},set:{value:(r=1<this.payload.length?this.payload[1].contents.trim():"",function(e){e!==Wikifier.getValue(t)&&(Wikifier.setValue(t,e),r&&new Wikifier(null,r))})}})}),jQuery(document.createElement("div")).attr("id",this.name+"-"+i+"-"+TempState[this.name][i]++).addClass("macro-"+this.name).wiki(this.payload[0].contents.replace(/^\n/,"")).appendTo(this.output)}}),Macro.add("numberslider",{handler:function(){function h(e){if(0<p){var t=Number(g+"e"+p),r=Number(n+"e"+p),i=Number(e+"e"+p)-t;return Number(i-i%r+t+"e-"+p)}var a=e-g;return a-a%n+g}function e(e){var t=Wikifier.getValue(m),r=Number(e.value),i=null;if(Number.isNaN(r)||!Number.isFinite(r))return e.value=t,!1;if((r=h(r))<g?r=g:f<r&&(r=f),null!==c)if(0<p){var a=Number(c.get()+"e"+p),n=Number(t+"e"+p),s=Number(r+"e"+p),u=s-n;a<u&&(u=(s-=u-a)-n,r=Number(s+"e-"+p)),i=Number(a-u+"e-"+p)}else{var o=c.get(),l=r-t;o<l&&(l=(r-=l-o)-t),i=o-l}return Wikifier.setValue(m,r),e.value=r,null!==i&&c.set(i),!0}var t=this;if(this.args.length<5){var r=[];return this.args.length<1&&r.push("variable name"),this.args.length<2&&r.push("default value"),this.args.length<3&&r.push("min value"),this.args.length<4&&r.push("max value"),this.args.length<5&&r.push("step value"),this.error("no "+r.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var m=this.args[0].trim();if("$"!==m[0]&&"_"!==m[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Util.slugify(m),a=Number(this.args[1]),g=Number(this.args[2]),f=Number(this.args[3]),n=Number(this.args[4]),s=5<this.args.length&&"autofocus"===this.args[5];if(Number.isNaN(a)||!Number.isFinite(a))return this.error("default value ("+this.args[1]+") is not a number");if(Number.isNaN(g)||!Number.isFinite(g))return this.error("min value ("+this.args[2]+") is not a number");if(Number.isNaN(f)||!Number.isFinite(f))return this.error("max value ("+this.args[3]+") is not a number");if(Number.isNaN(n)||!Number.isFinite(n)||n<=0)return this.error("step value ("+this.args[4]+") is not a number greater than zero");if(a<g)return this.error("default value ("+this.args[1]+") is less than min value ("+this.args[2]+")");if(f<a)return this.error("default value ("+this.args[1]+") is greater than max value ("+this.args[3]+")");var u,o,p=(u=String(n),-1===(o=u.lastIndexOf("."))?0:u.length-o-1);if(h(f)!==f)return this.error("max value ("+this.args[3]+") is not a multiple of the step value ("+this.args[4]+") plus the min value ("+this.args[2]+")");var l,c=null!==(l=t.contextSelect(function(e){return"numberpool"===e.name}))&&l.hasOwnProperty("pool")?l.pool:null;Config.debug&&this.debugView.modes({block:!0});var d=jQuery(document.createElement("div")),v=jQuery(document.createElement("input")),b=void 0,N=void 0;d.attr("id",this.name+"-body-"+i).addClass("macro-"+this.name).appendTo(this.output),v.attr({id:this.name+"-input-"+i,name:this.name+"-input-"+i,type:"range",min:g,max:f,step:n,tabindex:0}).on("change input."+Util.slugify(this.name),function(){e(this),"function"==typeof N&&N()}).on("keypress",function(e){13===e.which&&(e.preventDefault(),v.trigger("change"))}).appendTo(d),!Browser.isIE||9<Browser.ieVersion?(b=jQuery(document.createElement("span")).attr("id",this.name+"-value-"+i).appendTo(d),N=function(){b.text(Number(v.val()).toFixed(p))}):v.off("input."+Util.slugify(this.name)),v.val(a),e(v[0]),"function"==typeof N&&N(),s&&(v.attr("autofocus","autofocus"),postdisplay["#autofocus:"+v.attr("id")]=function(e){delete postdisplay[e],setTimeout(function(){return v.focus()},Engine.minDomActionDelay)})}})}();